<?xml version="1.0" encoding="us-ascii"?>

<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
  <!ENTITY RFC2045 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.2045.xml">
  <!ENTITY RFC3864 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.3864.xml">
  <!ENTITY RFC5598 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5598.xml">
  <!ENTITY RFC5617 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.5617.xml">
  <!ENTITY RFC6376 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6376.xml">
  <!ENTITY RFC6377 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6377.xml">
  <!ENTITY RFC6541 PUBLIC "" "http://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6541.xml">
]>

<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

<rfc category="exp" docName="draft-kucherawy-dkim-delegate-00"
	ipr="trust200902">

<?rfc toc="yes" ?>
<?rfc symrefs="yes" ?>
<?rfc sortrefs="yes"?>
<?rfc strict="no" ?>
<?rfc rfcedstyle="yes"?>
<?rfc subcompact="no"?>

<?rfc tocdepth="2"?>
<?rfc tocindent="yes"?>
<?rfc inline="yes"?>
<?rfc topblock="yes" ?>
<?rfc autobreaks="yes" ?>

<front>
	<title abbrev="DKIM-Delegate">
		Delegating DKIM Signing Authority
	</title>

	<author fullname="Murray S. Kucherawy"
		initials="M. S." surname="Kucherawy">

		<address>
			<email>superuser@gmail.com</email>
		</address>
	</author>

	<author fullname="D. Crocker"
		initials="D." surname="Crocker">

		<organization> Brandenburg InternetWorking </organization>

		<address>
			<postal>
				<street>675 Spruce Dr.</street>
				<city>Sunnyvale</city>
				<country>USA</country>
				<code>94086</code>
			</postal>

			<phone>+1.408.246.8253</phone>
			<email>dcrocker@bbiw.net</email>
			<uri>http://bbiw.net</uri>
		</address>
	</author>

	<date year="2014" />

	<area>Applications</area>

	<abstract>
		<t> DomainKeys Identified Mail (DKIM) permits a handling agent
		    to affix a digital signature to an email message,
		    associating a domain name with that message using
		    cryptographic signing techniques.  The digital signature
		    typically covers most of a message's original portions,
		    although the specific choices for content hashing are
		    at the discretion of the signer.  DKIM signatures survive
		    simply email relaying but typically are invalidated by
		    processing through Mediators, such as mailing lists.
		    For such cases, the signer needs a way to indicate that a
		    valid signature from some third party was anticipated, and
		    constitutes an acceptable handling of the message.  This
		    enables a receiver to conclude that the content is
		    legitimately from that original signer, even though its
		    original signature no longer validates. </t>

		<t> This document defines a mechanism for improving the
		    ability to assess DKIM validity for such messages. </t>
	</abstract>
</front>

<middle>
	<section anchor="background" title="Background">
		<t> DomainKeys Identified Mail <xref target="RFC6376"/>
		    defines a mechanism whereby a verified domain name can be
		    attached to a message, using a cryptographic signature.
		    It does not, however, assert that this domain name matches
		    a domain name found anywhere else in the message. </t>

		<t> DKIM signature survival is usually successful through
		    basic email relaying nodes.  It also survives simple
		    Mediators, such as mailbox forwarding agents, because
		    they only modify the message envelope and do not modify
		    the original message header or body.  Transit through
		    other Mediators, such as mailing lists, is usually
		    problematic, because they modify portions of the message
		    covered by the signature and therefore invalidate it. </t>

		<t> When a receiver needs to determine whether a message was
		    legitimately processed by a purported original signer, a
		    mechanism is needed that is more likely to survive transit
		    through Mediators.  This need is especially strong for
		    environments wishing to enforce policy linkage between the
		    author, the author's domain and specific email service
		    providers, such as when the latter two are the same.  An
		    example of such a need is when that original signer
		    publishes policies concerning the use of its domain name.
		    Examples are ADSP <xref target="RFC5617"/> and
		    DMARC <xref target="I-D.KUCHERAWY-DMARC-BASE"/>.  These
		    policies cannot be applied properly when legitimate mail
		    for the original signer's domain cannot be validated by
		    the final Receiver.  The potential for malfunction
		    otherwise is described in Section 5.2 of
		    <xref target="RFC6377"/>. </t>

		<t> The issues with mailing lists and similar re-mailing
		    applications can be resolved by a mechanism that permits
		    the original signer's domain ("A") to indicate that some
		    other domain ("B") is explicitly permitted to re-sign
		    content generated by "A", such that a Receiver can observe
		    signaling from both "A" and "B" that this relationship
		    exists. </t>

		<t> An experimental attempt to do this appeared in
		    <xref target="RFC6541"/>.  The method presented there
		    imposes a burden on the original signing domain to publish
		    those relationships a priori, via the DNS.  This proved
		    cumbersome with poor scaling properties.  So, a mechanism
		    that does not have such an external dependency is
		    preferred. </t>
	</section>

	<section anchor="defs" title="Definitions">
		<t> Numerous terms used here, especially "Author",
		    "Originator", "Receiver", and "Recipient", are defined in
		    <xref target="RFC5598"/>.  DKIM-related terminology, such
		    as "Signing Domain", are taken from the DKIM
		    specification <xref target="RFC6376"/>. </t>
	</section>

	<section anchor="descr" title="DKIM-Delegate Specification">
		<t> An email header field, called "DKIM-Delegate", is defined.
		    When present, it asserts an ephemeral relationship between
		    an original message signing domain and a later intermediary
		    (Mediator). </t>

		<section title="Design Summary">
			<t> An "Original Signer" (typically the Originator
			    serving the Author) affixes two DKIM signatures
			    to a message.  One is of the usual type, covering
			    the entire message, and the second is tailored
			    to better survive transit through Mediators such
			    as authorized mailing lists.  A DKIM-Delegate
			    field is added to the message, to indicate that
			    this mechanism is in force; this is covered by
			    the second signature (and possibly, but not
			    necessarily, the first).  Optionally, a
			    Mediator also signs the message, to provide a
			    reliable indication of handling by the Mediator.
			    If a Receiver finds that the Original Signer's
			    "normal" signature does not validate or is
			    missing, it can perform DKIM-Delegate
			    evaluation. </t>

			<t> In combination with DKIM signatures, this
			    mechanism can aid a receiver in assessing whether
			    the message was legitimately handled by the
			    intermediary and whether the message was likely to
			    have had a legitimate signature by the original
			    signing domain, even when that original signature
			    became invalid.  This makes it possible to
			    identify such messages separately from those
			    without these assurances, and thus permits
			    treating the latter with more skepticism. </t>
		</section>

		<section title="Specification">
			<t> The specific mechanism operates as follows:

			    <list style="numbers">
				<t> A "Primary" DKIM Signature is affixed to a
				    message by a handling agent, identifying
				    the Originator's domain and using typical
				    signing choices, such as covering the
				    entire message content in the body hash.
				    (That is, it does not use the "l="
				    tag.) </t>

				<t> The signer adds a DKIM-Delegate header
				    field identifying the Originator's domain.
				    It can also identify the specific domain(s)
				    with which it wishes to claim an ephemeral
				    relationship; absent this indication, the
				    list of candidate domains is implicit from
				    elsewhere in the message header (see
				    below). </t>

				<t> The signer affixes a "Secondary" DKIM
				    signature that is configured so as to
				    better survive transit through the
				    delegated domain(s).  The distinctive
				    characteristic of a Secondary signature is
				    that its hashes cover less of the message;
				    it also might use more permissive
				    canonicalization and/or have an especially
				    short expiration time.  The signature MUST
				    cover the DKIM-Delegate header field, in
				    order to validate its use for the message.
				    Suggestions for details of a Secondary
				    signature are discussed in
				    <xref target="secondary" />. </t>

				<t> An authorized Mediator SHOULD affix its
				    own, normal DKIM signature to the
				    message. </t>

				<t> The Receiver attempts to validate the
				    primary signature affixed by the original
				    signer.  If it is valid, the requirements
				    of this profile are satisfied (and the
				    algorithm terminates here). </t>

				<t> The Receiver attempts to validate the
				    Secondary (delegation) signature affixed
				    by the original signer.  If it is not
				    valid (or not found), the requirements of
				    this profile cannot be satisfied (and the
				    algorithm terminates here). </t>

				<t> The Receiver confirms that the Secondary
				    signature header hash includes at least
				    the DKIM-Delegate header field, and that
				    the "d=" value in the Secondary signature
				    matches the "d=" value in the
				    DKIM-Delegate field.  If either is not
				    true, the requirements of this profile
				    cannot be satisfied (and the algorithm
				    terminates here). </t>

				<t> If the DKIM-Delegate field includes a
				    list of domain names to which delegation
				    of re-signing authority is claimed, call
				    this set "D". </t>

				<t> If the DKIM-Delegate signature does not
				    include such a list, the Receiver collects
				    all header fields that were covered by the
				    header hash of the Secondary DKIM
				    signature and that contain recipient
				    addresses.  These can be found in that
				    signature's "h=" tag.  The obvious
				    examples are the To and Cc fields (if
				    present).  The Receiver extracts the set
				    of domain names from the collected header
				    fields, and calls this set "D". </t>

				<t> The Receiver performs normal validation
				    checks of all other DKIM signatures on the
				    message that include the entire message
				    body in their body hashes, and stores the
				    set of domains from passing signatures in
				    set "S". </t>

				<t> If the intersection of "D" and "S" is not
				    empty, the requirements of this profile
				    are satisfied; otherwise, the requirements
				    are not satisfied.  </t>
			    </list> </t>
		</section>

		<section anchor="syntax" title="Syntax">
			<t> The content of the DKIM-Delegate header field is
			    a tag-list as defined in Section 3.2 of
			    <xref target="RFC6376"/>.  The valid tags are:

			    <list style="hanging">
				<t hangText="d="> Author domain
					(plain-text; REQUIRED).
				    This value names the domain of the Author,
				    which is delegating signing authority to
				    one or more other domains. </t>

				<t hangText="t="> Delegation target
					(plain-text; OPTIONAL).
				    This value is a comma-separated list of
				    domain names to which the authority to
				    sign on behalf of the Author domain is
				    being delegated.  When not present, this
				    list is inferred from the domain names
				    present in the recipient fields (To, Cc)
				    of the header. </t>
			    </list> </t>

			<t> As with DKIM itself, any other tag MUST be
			    ignored. </t>
		</section>
	</section>

	<section anchor="secondary"
	         title="Considerations for Secondary Signatures">

		<t> The Secondary (delegation) signature MUST cover at least
		    the DKIM-Delegate field and the visible recipient fields
		    of the message, but might not cover any of the content.
		    Under this profile, domains that appear in the explicit
		    delegation list (or are otherwise inferred from the
		    recipient header fields) are permitted to alter and
		    re-send the content. </t>

		<t> Delegated domains SHOULD sign the message.  However,
		    receivers MAY accept a Secondary signature for messages
		    lacking a delegated signature if the receiver can
		    otherwise determine that the message was handled through a
		    delegated domain. </t>

		<t> Original signers need to tailor the secondary signature to
		    best survive transit through the designated Mediators.
		    Settling on a common signing profile for these
		    delegation "tokens" is likely to change with
		    experience. </t>

		<t> A reasonable example signature profile could cover the
		    following header fields:

		    <list style="symbols">
			<t> From (required by DKIM) </t>

			<t> To and Cc (contain Receiver addresses) </t>

			<t> Message-Id (binds the signature to a specific
			    message) </t>

		        <t> Date (binds the signature to a specific date and
			    time) </t>

		        <t> DKIM-Delegate (signals to participating receivers
			    that an ephemeral delegation of signing authority
			    is in effect) </t>
		    </list> </t>

		<t> Subject, though normally covered by signatures as per
		    Section 5.4 of <xref target="RFC6376" />, can be omitted
		    for a Secondary signature if the original signer
		    anticipates legitimate alteration of it by a Mediator.
		    See also <xref target="disc_header" />. </t>

		<t> The Secondary signature might cover the message content,
		    but allow for legitimate Mediator modifications by
		    including an "l=" tag in the signature.  This would
		    require the Mediator to restict its alterations to involve
		    appended content only.  Hence the Secondary signature can
		    use an "l=" value reflecting the entire message as
		    generated by the Author, or "0" (zero) allowing a complete
		    reformatting of the message.  Obviously the latter grants
		    the Mediator considerable latitude in what it will
		    ultimately emit, while the former is much more
		    constrained.  The original signer of the message can
		    choose whichever is more appropriate for its own policies
		    and requirements. </t>

		<t> This use of DKIM's "l=" value assumes messages sent to the
		    Mediator that are not part of a multipart message
		    structure, as described in Multipurpose Internet Mail
		    Extensions (MIME; see <xref target="RFC2045"/>).  It
		    might not be possible to select a practical signing
		    length for messages in other than the basic message
		    format. </t>

		<t> The expiration time on the Secondary signature needs to be
		    long enough to permit evaluation by receivers of the
		    re-submitted message, yet short enough to limit the
		    potential for unauthorized replay attacks.  A good choice
		    is a small number of days or even hours. </t>
	</section>

	<section anchor="disc" title="Discussion">
		<t> The use of the Primary signature ensures that if the
		    original message arrives unmodified, the Receiver is
		    assured of its legitimacy as having been generated and
		    sent by the original signer, irrespective of what
		    Mediator handled it. </t>

		<t> Mediators, such as mailing list software, commonly make
		    adjustments to a message prior to re-submitting it for
		    transfer to final recipients.  Adjustments often include
		    prepending list-identifying material to the Subject
		    field, or appending URIs and such to the message body
		    referring Receivers to further information about the list
		    itself.  This will almost always invalidate the Primary
		    signature, so downstream receivers cannot be sure
		    (via DKIM, at least) where the message originated. </t>

		<section anchor="disc_header" title="Detecting Header Changes">
			<t> During the development of DKIM, consideration was
			    given to the notion of using the "z=" tag (if
			    present) to identify changes to the header made
			    in transit that render a signature invalid.
			    Ultimately it was decided that a signature should
			    be considered invalid even if analysis of the
			    content of "z=" could be used to confirm that the
			    change made in transit was innocuous.  The content
			    of "z=" was meant to be used only as a debugging
			    tool by humans. </t>

			<t> Under this use, if the Subject header field was
			    included in the header hash, it may be useful to
			    use "z=" (if present) to detect changes made to
			    the Subject field, if any.  If those changes
			    appear to be trivial, such as the insertion of a
			    prefix string at the front of the header field's
			    original value, the Primary and/or Secondary
			    signature could be re-attempted with the original
			    Subject field value.  If the re-attempt succeeds,
			    the verifier could decide that this profile's
			    requirements have been satisfied. </t>
		</section>
	</section>

	<section anchor="security" title="Security Considerations">
		<t> Use of this header field (and DKIM as described here)
		    amounts to an ephemeral granting of the ability for the
		    first Receivers (the Mediators named in the To and Cc
		    fields) to generate content that the ultimate Receivers
		    will consider valid on behalf of the Author.  A
		    compromised Mediator can thus replace the original content
		    in its entirety while still satisfying this profile. </t>

		<t> Section 8.2 <xref target="RFC6376" /> discusses the risks
		    of using "l=" tags when generating signatures.  The "l="
		    tag and its implications were discussed at length during
		    the development of DKIM, and its use today is not popular
		    because it opens up the possibility of replay-type
		    exploits where legitimate, signed messages are co-opted,
		    modified, and then sent as spam. </t>

		<t> Use of "l=" here is advocated only for the specific use
		    cases this document seeks to address, namely survivability
		    of Originator signatures through modifying Mediators such
		    as lists.  It is believed that the exposure thus created
		    is tolerable, in particular because a Mediator signature
		    without "l=" is required for this profile to be satisfied,
		    and the exposure created by use of "l=" in the Secondary
		    signature is constrained by a short signature expiration
		    time. </t>
	</section>

	<section anchor="iana" title="IANA Considerations">
		<t> IANA is requested to make the following new entry in the
		    Permanent Message Header Field Names registry, per
		    <xref target="RFC3864"/>:
			<figure> <artwork>
  Header field name: DKIM-Delegate
  Applicable protocol: mail ([RFC5322])
  Status: Experimental
  Author/Change controller: IETF
  Specification document(s): [this document]
  Related information:
      Requesting review of any proposed changes and additions to
      this field is recommended.
			</artwork> </figure> </t>
	</section>
</middle>

<back>
	<references title="Normative References">
		&RFC3864;
		&RFC6376;
	</references>

	<references title="Informative References">
		&RFC2045;
		&RFC5598;
		&RFC5617;
		&RFC6377;
		&RFC6541;

		<reference anchor="I-D.KUCHERAWY-DMARC-BASE">
			<front>
				<title> Domain-based Message Authentication,
				        Reporting and Conformance (DMARC)
				</title>

			        <author fullname="Murray Kucherawy"
				        role="editor"
				        initials="M." surname="Kucherawy" />

		        	<author fullname="Elizabeth Zwicky"
					role="editor"
					initials="E." surname="Zwicky" />

				<date />
			</front>

			<seriesInfo name="I-D"
			            value="draft-kucherawy-dmarc-base" />
		</reference>
	</references>

	<section anchor="example" title="Example">
		<t> [To Be Completed] </t>
	</section>

	<section anchor="thanks" title="Acknowledgments">
		<t> The authors wish to acknowledge
		    Steve Atkins,
		    Barry Leiba,
		    (other names)
		    for their comments during the development of this
		    document. </t>
	</section>
</back>

</rfc>
